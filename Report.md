# Отчёт о выполнении задачи "Delivery robot"

- [Отчёт о выполнении задачи "Delivery robot"](#отчёт-о-выполнении-задачи-delivery-)
- [Постановка задачи](#постановка-задачи)
  - [Известные ограничения, примечания и вводные данные](#известные-ограничения-примечания-и-вводные-данные)
    - [Цели и Предположения Безопасности (ЦПБ)](#цели-и-предположения-безопасности-цпб)
  - [Архитектура работы системы](#архитектура-работы-системы)
    - [Компоненты](#компоненты)
    - [Алгоритм работы решения](#алгоритм-работы-решения)
    - [Описание Сценариев (последовательности выполнения операций), при которых ЦБ нарушаются](#описание-сценариев-последовательности-выполнения-операций-при-которых-цб-нарушаются)
      - [Негативный сценарий 1. DDOS атака на Communication](#негативный-сценарий-1-ddos-атака-на-communication)
      - [Негативный сценарий 2. Заказ прислан злоумышленником](#негативный-сценарий-2-заказ-прислан-злоумышленником)
      - [Негативный сценарий 3. Некорректный заказ](#негативный-сценарий-3-некорректный-заказ)
      - [Негативный сценарий 4. Атака на Third-party software](#негативный-сценарий-4-атака-на-third-party-software)
      - [Негативный сценарий 5. Взлом Communication](#негативный-сценарий-5-взлом-communication)
      - [Негативный сценарий 6. Перезапись данных при повторном заказе](#негативный-сценарий-6-перезапись-данных-при-повторном-заказе)
      - [Негативный сценарий 7. Бездействие компонента](#негативный-сценарий-7-бездействие-компонента)
      - [Негативный сценарий 8. Скрытые поля](#негативный-сценарий-8-скрытые-поля)
      - [Негативный сценарий 9. Отказ модуля gps](#негативный-сценарий-9-отказ-модуля-gps)
      - [Негативный сценарий 10. Ввод пароля не в пункте назначения](#негативный-сценарий-10-ввод-пароля-не-в-пункте-назначения)
      - [Негативный сценарий 11. Перебор паролей](#негативный-сценарий-11-перебор-паролей)
      - [Негативный сценарий 12. Получение неверных данных от компонента](#негативный-сценарий-12-получение-неверных-данных-от-компонента)
      - [Негативный сценарий 13. Потеря чувствительной информации](#негативный-сценарий-13-потеря-чувствительной-информации)
      - [Сводная таблица негативных сценариев](#сводная-таблица-негативных-сценариев)
    - [Указание "доверенных компонент" на архитектурной диаграмме с обоснованием выбора.](#указание-доверенных-компонент-на-архитектурной-диаграмме-с-обоснованием-выбора)
    - [Известные проблемы реализации](#известные-проблемы-реализации)
    - [Политики безопасности](#политики-безопасности)
  - [Запуск приложения и тестов](#запуск-приложения-и-тестов)
    - [Запуск приложения](#запуск-приложения)
    - [Запуск тестов](#запуск-тестов)

## Постановка задачи
Необходимо создать программное обеспечение (далее – ПО) для робота-доставщика (далее – робот), с помощью которого можно обеспечить безопасную доставку и выдачу заказа (верифицированному) клиенту только в указанной точке, возвращение на базу и завершение работы.

## Известные ограничения, примечания и вводные данные:
**По условию:**
1. По условиям организаторов должна использоваться микросервисная архитектура и шина обмена сообщениями для реализации асинхронной работы сервисов.
2. Между собой сервисы общаются через шину сообщений (message bus), а всё снаружи принимают в виде REST запросов.
3. Надёжность аппаратуры не учитывается.
4. Заказ не имеет массы и объёма.
5. Графический интерфейс для взаимодействия с пользователем не требуется, достаточно примеров REST запросов.
6. Приборная точность позиционирования достаточна для выполнения задания доставки.
7. Механизм безопасной передачи пароля клиенту не требуется реализовывать в рамках работы -> клиент **знает** правильный пароль от заказа.
**Добавленные в ходе анализа:**
8. Движение осуществляется по прямой.
9. База имеет фиксированные координаты (x0 = 0, y0 = 0).
10. Геолокация: позиционирование на местности по двум системам - GPS (спутниковая навигационная система) и ИНС (инерциальная навигационная система).
11. Автономность: робот должен корректно продолжать работу в т.ч. при потере связи с сервером или GPS вплоть до накопления некоторой критической ошибки ИНС (для упрощения возбмем некоторое константное время 10 секунд), а иначе попытка возвращения на базу.
12. ИНС является автономной навигационной системой, но накапливает ошибку, поэтому должна использоваться только в случае сбоя GPS.
13. Контроль: уровень заряда, распознавание препятсвий, поломка. В случае критических проблем дрон должен вернуться на базу.
14. Х1 и Y1 - адрес доставки заказа.
15. По умолчанию батареи робота хватает на доставку в квадрате с противолежищими вершинами (-100;-100) и (100;100).  


### Цели и Предположения Безопасности (ЦПБ)
**Бизнес-цель:**
  - Доставка и выдача верифицированному клиенту заказа в заданной точке.

**Цели безопасности:**
1. Обеспечение сохранности груза до момента передачи авторизованному клиенту.
2. Получение задания только от корпоративного сервера.
3. В случае многократных попыток неавторизованного доступа заблокировать груз и вернуться на склад.
**Added:**
4. Осуществлять проверку пинкода только по достижению указанной в заказе точки.
5. В случае потери связи с GPS продолжать движение по ИНС, если сигнал не вернется - возвращаться на базу.
6. Базовая защита REST-коммуникаций.
7. Принимать только валидные заказы.
8. Сохранение "чувствительной" информации.

**Предположения безопасности:**
Целями безопасности дрона не являются:
1. Защита от атак с использованием физического доступа.
2. Защита от намеренного искажения GPS координат.
3. Задача считается заавершенной только по прибытии обратно на базу.

## Архитектура работы системы
![DFD](./pics/dfd.png?raw=true "Архитектура")

### Компоненты

| Название | Назначение | Комментарий |
|----|----|----|
|*Central Control Unit (central)* | Принимает в работу заказ, сохраняет требуемую точку доставки и пинкод, запускает расчет и старт движения движение. При получении сообщения о достижении точки назначения проверяет по координатам соответствие, разрешает считывать пинкод. Проверяет пинкод ограниченное количество раз, по закрытии или при ошибке пароля более 3 раз запускает расчет и движение обратно. По достижении пункта назначения инициирует отправку сообщения со статусом заказа через Communication на Fleet. |  |
|*Motion control (motion)* | Осуществляет движение по полученным направлению и скорости в течении заданного расстояния с учетом аппаратных ограничений. | |
|*Client (client)* | Взаимодействует с роботом через API. Использует для авторизации уже известный ему уникальный PIN код. | |
|*Fleet management service (fleet)*  | Абстрактный сотрудник выдает заказы роботу при помощи файла request.rest, получая на REST интерфейс уведомления о принятии заказа к выполнению и о результате доставки (т.е. в т.ч. и возвращении робота на базу). | |
|*Позиционирование (position)* | Осуществляет функции расчета параметров движения. Ведет GPS-независимую карту движения. Строит аварийный маршрут возвращения на базу. Выдаёт текущие координаты (x, y, z). Отслеживает прерывание сигнала. Отслеживает ошибки позиционирования. | Может быть декомпозировано на GPS и ИНС + лог пройденного пути для верификации координат робота. |
|*Communication block (communication)* | Разворачивает REST API для приема заказа, передачи его далее по шине, а так же для передачи сообщений подтверждения и результата доставки. | |
|*HMI (hmi)* | Разворачивает REST API для приема заказа и передачи его далее по шине. Поскольку подразумевается автономное функционирование робота, то данный элемент считаем аппаратной составляющей со всеми вытекающими последствиями для безопасности.  | |
|*Sensors (sensors)* | Открывают замки при команде от монитора безопасности, через 5 секунд закрывает, отправляя об этом сообщение. | Camera - вынесена отдельно в целях декомпозиции |
|*Camera (camera)* | При вводе пинкода должна осуществлять съемку человека, что он забрал заказ. | |
|*Security monitor*<br>(монитор безопасности) | Авторизует операцию, если она удовлетворяет заданным правилам или блокирует её в противном случае | |
|*Message bus* | Шина сообщений и брокер - сервис передачи сообщений от источника получателям | kafka+zookeeper | |


### Алгоритм работы решения

![Sequence diagram](./pics/sd.png?raw=true "Диаграмма вызовов")

---
Message bus и Security Monitor на диаграммах опущены для лучшей читаемости и уменьшения размера картинки. КАЖДОЕ сообщение внутри системы проходит через monitor, который исходя из политик принимает решение пропустить его или нет.
---

### Описание Сценариев (последовательности выполнения операций), при которых ЦБ нарушаются

Для начала произведем анализ системы.
По условию задания, компоненты **Message Bus** и **Security Monitor** доверенные, что вполне логично - они являются основополагающими элементами взаимодейтсвия системы.
Рассмотрим теперь **Central Control Unit** - он является главным логическим узлом всей системы, следовательно также будет являться доверенным. Остается вопрос - можно ли вынести из него некоторый функционал, чтобы уменьшить количество кода, требующего проверки. Представляется, что на данный момент такого функционала нет.

Сугубо теориетически, возможно представить вынос основных функций **central** в **monitor**, однако это фактически все равно не приводит к уменьшению проверяемой кодовой базы в два раза, а кроме того нарушается логика разделения компонентов.

В результате авторской оценки, блок **position** был усложнен до более реальной схемы с независимыми блоками **GPS** и **ИНС (Microelectromechanical systems (mems))**, что позволяет закрыть вопросы с однозначной оценкой точного местоположения и таким образом закрывает требование ЦБ о выдаче заказа только в заданной точке.

Здесь следует сделать ремарку, что реальное движение так же подразумевает итерационное движение, а не единый акт движения по прямой. Таким образом, представляется адекватным каждое +- небольшй отрезок перемещения логгировать ОДНОВРЕМЕННО и на **GPS** и на **ИНС** c последующим сравнением их в рамках погрешности ИНС. Таким образом, длительность данного отрезка движения не должна превышать более половины интервала наколения блоком ИНС ошибки, чтобы было возможно возвращение к последней зафиксированной точке. Поскольку резервное возвращение осуществляется блоком ИНС, а наши координаты важны для ЦБ, то блок **GPS** будет вынесен в отдельный недоверенный компонент, а ИНС будет включаться в состав **position** и будет доверенным.

В рамках работы отключение GPS возможно эмулировать вызовом случайного сообщения о прерывании от **GPS**, а итерационность движения реализовать через дробление пути на участки заданной длины.

Если будет взломан компонент **motion**, то это приведет к нарушению бизнес-функции робота, но заявленные ЦБ будут выполняться.

Поскольку автор исходит из того, что **HMI** - интерфейс на роботе, недоступный извне через REST (т.е. не так, как это реализовано сейчас для удобства), то взлом **HMI** приведет к максимум нарушению бизнес-функции робота, но ЦБ будут соблюдаться. Возможно, что злоумышленник постфактум сможет узнать пароль, введенный клиентом (в комбинации с другими взломами), но т.к. **HMI** активируется только при достижении зваявленной точки, то это не является проблемой. Впрочем, могут быть вопросы к реверсу генератора случайных паролей на сервере при большой выборке данных, но это уже выходит за рамки работы.

Самой серьезной проблемой представляется взлом замков **Sensors**, что позволит злоумышленнику их просто открыть. Таким образом, его следует добавить в доверенные компоненты. По этой причине, блок **Camera** был вынесен отдельно - чтобы не проверять его, поскольку он не оказывает влияние на ЦБ и на основную функцию.

Проблема могла бы быть если взломан **Communication** – поскольку в реализации заказ один, то получение нового заказа при выполнении старого перезаписала бы требуемый пинкод и адрес и позволило бы злоумышленнику получать чужой заказ. Для противодействия этого была реализована блокировка приема новых сообщений через политики безопасности до возвращения робота на базу.
Кроме того, у робота фактически есть одна внешняя точка доступа – через **Communicator**, который, к тому же использует Flask. Следовательно – этот компонент следует тщательно досматривать – на политики проверки сообщений от него навесить жесткие ограничения по валидации содержимого: длина, значения, отрубать при возможности, а также уделить особое внимание настройке сетевых параметров так, чтобы связаться с ним можно было только от заранее указанного сервера с авторизацией и т.д. Кроме того, в данном случае имеется смысл например в реализации алгоритма Диффи-Хеллмана.

Может ли комбинация взломов компонентов нарушить ЦБ? Понятно, что в случае доверенных компонент - да. Если же говорить о недоверенных, т.е. gps, hmi, motion, communication, camera - ни один из них не связан напрямую с другим, а следовательно их некорректное взаимодействие практически невозможно координировать между собой. Автор считает, что наиболее вероятным среди всех комбинаций - передача "лишней информации" с телом корректного ответа компонента и дальнейшая его передача через communication, которая где-то по пути перехватывается злоумышленником. Это возможно решить путем проверки передаваемой "наружу" информации в monitor.

Таким образом, становится возможным сформулировать список доверенных компонентов (см. соответсвующий раздел) и рассмотреть возможные сценарии нарушения ЦБ.

Автором были определены 13 наиболее вероятных сценариев атаки на систему:
1. DDOS атака на Communication;
2. Заказ прислан злоумышленником, а не сервером, сюда же MITM;
3. Взлом сервера и выдача им некорректного заказа - например, который находится слишком далеко.
4. Атака через Third-party software (например, Flask в communication);
5. Взлом Communication как открытой точки доступа в сеть;
6. Перезапись "чувствительных" данных при повторном заказе;
7. Бездействие какого-либо компонента;
8. Скрытые поля и их использование для code injections;
9. Отказ модуля **gps**
10. Ввод паролей не в пункте назначения;
11. Перебор паролей;
12. Получение неверных данных (например, координат) от компонента;
13. Вынос "чувствительной" информации (например, фото клиента) из системы при помощи комбинации взломанных компонентов;

Здесь необходимо сделать ремарку, что концепция сохранения локальных копий используемых библиотек и проверки только поступающих обновлений подразумевает идею о том, что в условиях разработанной архитектуры простая эксплуатация уже существующей уязвимости в компоненте не позволит выйти за его пределы, т.к. если это и возможно, то потребуется доступ на уровне RCE, т.е. злоумышленнику все равно придется как-то доставлять код во взломанный компонент, поэтому сделан специальный **communication** в качестве буфера перед системой и **monitor**, который позволяет осуществлять валидацию.

В результате, в текущей реализации системы наиболее вероятным представляется невыполнение бизнес-функции в результате атаки на дрон при соблюдении всех заявленных ЦБ.

![Негативные сценарии](./pics/sd_risks.png?raw=true "Негативные сценарии")

### Негативный сценарий 1. DDOS атака на Communication
![Негативные сценарии](./pics/sd_1.png?raw=true "")

Нарушается цель безопасности №6 и бизнес-функция.
Компенсируется отключением компонента Communication до необходимости отправить сообщение со статусом операции (опционально, при получении какого-то количества "неправильных" сообщений).

### Негативный сценарий 2. Заказ прислан злоумышленником
![Негативные сценарии](./pics/sd_2.png?raw=true "")

Нарушается цель безопасности №1,2.
Компенсируется использованием аутентификацией сервера, например, реализацией алгоритма Диффи-Халлмана

### Негативный сценарий 3. Некорректный заказ
![Негативные сценарии](./pics/sd_3.png?raw=true "")

Нарушается цель безопасности №7.
Компенсируется валидацией заказа - как далеко находится точка, хватит ли до нее заряда и т.д.

### Негативный сценарий 4. Атака на Third-party software
![Негативные сценарии](./pics/sd_4.png?raw=true "")

Нарушается цель безопасности (в теории) №1,2,4,5,6.
Компенсируется проверкой входящих в доверенные компоненты частей, использованием локальных и/или проверенных копий библиотек, проверкой обновлений.

### Негативный сценарий 5. Взлом Communication
![Негативные сценарии](./pics/sd_5.png?raw=true "")

Нарушается цель безопасности №2,6.
Компенсируется настройкой доступа только с доверенного списка адресов, с четким содержимым входящих сообщений и т.п. безопасностью.

### Негативный сценарий 6. Перезапись данных при повторном заказе
![Негативные сценарии](./pics/sd_6.png?raw=true "")

Нарушается цель безопасности №1,2.
Компенсируется блокировкой возможности повторного заказа.

### Негативный сценарий 7. Бездействие компонента
![Негативные сценарии](./pics/sd_7.png?raw=true "")

Нарушается бизнес-функция.
Компенсация представляется невозможной -> решения автором не придумано.

### Негативный сценарий 8. Скрытые поля
![Негативные сценарии](./pics/sd_8.png?raw=true "")

Нарушается цель безопасности №1,7.
Компенсируется валидацией входящих (опционально исходящих) сообщений, экранированием полей.

### Негативный сценарий 9. Отказ модуля gps
![Негативные сценарии](./pics/sd_9.png?raw=true "")

Нарушается цель безопасности №5.
Компенсируется еще на уровне логики работы системы.

### Негативный сценарий 10. Ввод пароля не в пункте назначения
![Негативные сценарии](./pics/sd_10.png?raw=true "")

Нарушается цель безопасности №4.
Компенсируется активацией компонента доверенным компонентом при достижении точки, что зафиксированно другим доверенным компонентом.

### Негативный сценарий 11. Перебор паролей
![Негативные сценарии](./pics/sd_11.png?raw=true "")

Нарушается цель безопасности №3.
Компенсируется ограничением количества попыток.

### Негативный сценарий 12. Получение неверных данных от компонента
![Негативные сценарии](./pics/sd_12.png?raw=true "")

Нарушается цель безопасности №1,2,3,4.
Компенсируется на уровне архитектуры системы, однако требует дальнейшего изучения.

### Негативный сценарий 13. Потеря чувствительной информации
![Негативные сценарии](./pics/sd_13.png?raw=true "")

Нарушается цель безопасности №8.
Компенсируется валидацией исходящих сообщений.


#### Сводная таблица негативных сценариев*

|№  | Название | Скомпрометированная/Атакованная часть системы | Нарушенная цель безопасности |
|----|----|----|----|
|1 | DDOS атака на Communication | Communication | 6 |
|2 | Заказ прислан злоумышленником | Communication, Central | 1,2 |
|3 | Некорректный заказ | Central | 7 |
|4 | Атака на Third-party software | Any untrusted | 1,2,4,5,6 |
|5 | Взлом Communication | Communication | 2,6 |
|6 | Перезапись данных при повторном заказе | Communication, Central | 1,2 |
|7 | Бездействие компонента | Any untrusted | - |
|8 | Скрытые поля | Communication, Central | 1,7 |
|9 | Отказ модуля gps | Position, GPS | 5 |
|10 | Ввод пароля не в пункте назначения | HMI | 4 |
|11 | Перебор паролей | Central | 3 |
|12 | Получение неверных данных от компонента | Central | 1,2,3,4 |
|13 | Потеря чувствительной информации | Communication | 8 |

### Указание "доверенных компонент" на архитектурной диаграмме.

В предыдущем параграфе были рассмотрены возможные сценарии нарушения ЦБ, по результатам чего были определены доверенные компоненты - **monitor**, **message bus**, **position**, **central** и **sensors**, по причине того, что шина обмена сообщений и монитор безопасности являются общесистемными, а также мы хотим доверять результатам работы блока управления роботом, его модулю позиционирования и замкам хранилища заказа.

![DFD-TCB](./pics/dfd_trusted.png?raw=true "Доверенные компоненты")

Теоретически, шину обмена сообщениями можно сделать недоверенным компонентом, но тогда необходимо будет реализовать механим верификации сообщений. Например, можно использовать технологию типа blockchain.
Цена этого изменения - усложнение обмена сообщениями, дополнительные накладные расходы на верификацию, снижение производительности системы, возможно также возникновение нестабильности и различные ситуации гонок.

### Известные проблемы реализации
- Не реализованы вызовы прерывания "ошибка GPS"
- Не реализовано межпоточное обновление координат во время движения (в реальности это независимые датчики, но в коде требовалось бы связать два разных контейнера, чтобы обновлять координаты прямо во время выполнения кода движения, поэтому на данный момент синхронизация реализована как окончание каждого этапа движения)
- Не реализована фактическая отправка ответов на сервер (проблемы с сетью между docker контейнерами)

### Политики безопасности
```python {lineNo:true}


```

## Запуск приложения и тестов

### Запуск приложения

см. [инструкцию по запуску](../../README.md)

### Запуск тестов

_Предполагается, что в ходе подготовки рабочего места все системные пакеты были установлены._

Запуск примера: открыть окно терминала в Visual Studio code, в папке robot с исходным кодом выполнить команду:

**make run**
или **docker-compose up -d**

Примечание: контейнер broker имеет свойство падать при запуске, поэтому спустя секунд 15 после запуска команды **make run** имеет смысл проверить, находится ли он в состоянии UP и в случае чего повторно его запустить.

Примечание 2: сервисам требуется некоторое время для начала обработки входящих сообщений от kafka, поэтому перед переходом к тестам следует сделать паузу не менее минуты.

Запуск тестов:
**make test**
или **pytest**

Будут выполнены N тестов, N на корректность работы, N на безопасность, ожидаемое время выполнения ~ X минут X секунд.

Ожидаемый результат выглядит следующим образом:

```python {lineNo:true}
tests/e2e/test.py::test_activate PASSED
tests/e2e/test.py::test_asking_task PASSED
tests/e2e/test.py::test_write_order PASSED
tests/e2e/test.py::test_success_result PASSED
tests/e2e/test.py::test_surface_result PASSED
tests/e2e/test.py::test_activate_without_token PASSED
tests/e2e/test.py::test_bruteforce PASSED
tests/e2e/test.py::test_repeated_task PASSED
```
