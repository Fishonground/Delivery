# Отчёт о выполнении задачи "Delivery robot"

- [Отчёт о выполнении задачи "Delivery robot"](#отчёт-о-выполнении-задачи-delivery-robot)
- [Постановка задачи](#постановка-задачи)
- [Известные ограничения, примечания и вводные данные](#известные-ограничения-примечания-и-вводные-данные)
- [Цели и Предположения Безопасности (ЦПБ)](#цели-и-предположения-безопасности-цпб)
- [Архитектура работы системы](#архитектура-работы-системы)
    - [Компоненты](#компоненты)
    - [Алгоритм работы решения](#алгоритм-работы-решения)
    - [Описание Сценариев (последовательности выполнения операций), при которых ЦБ нарушаются](#описание-сценариев-последовательности-выполнения-операций-при-которых-цб-нарушаются)
      - [Негативный сценарий 1. DDOS атака на Communication](#негативный-сценарий-1-ddos-атака-на-communication)
      - [Негативный сценарий 2. Заказ прислан злоумышленником](#негативный-сценарий-2-заказ-прислан-злоумышленником)
      - [Негативный сценарий 3. Некорректный заказ](#негативный-сценарий-3-некорректный-заказ)
      - [Негативный сценарий 4. Атака на Third-party software](#негативный-сценарий-4-атака-на-third-party-software)
      - [Негативный сценарий 5. Взлом Communication](#негативный-сценарий-5-взлом-communication)
      - [Негативный сценарий 6. Перезапись данных при повторном заказе](#негативный-сценарий-6-перезапись-данных-при-повторном-заказе)
      - [Негативный сценарий 7. Бездействие компонента](#негативный-сценарий-7-бездействие-компонента)
      - [Негативный сценарий 8. Скрытые поля](#негативный-сценарий-8-скрытые-поля)
      - [Негативный сценарий 9. Отказ модуля gps](#негативный-сценарий-9-отказ-модуля-gps)
      - [Негативный сценарий 10. Ввод пароля не в пункте назначения](#негативный-сценарий-10-ввод-пароля-не-в-пункте-назначения)
      - [Негативный сценарий 11. Перебор паролей](#негативный-сценарий-11-перебор-паролей)
      - [Негативный сценарий 12. Получение неверных данных от компонента](#негативный-сценарий-12-получение-неверных-данных-от-компонента)
      - [Негативный сценарий 13. Потеря чувствительной информации](#негативный-сценарий-13-потеря-чувствительной-информации)
      - [Сводная таблица негативных сценариев](#сводная-таблица-негативных-сценариев)
 - [Указание "доверенных компонент" на архитектурной диаграмме.](#указание-доверенных-компонент-на-архитектурной-диаграмме)
 - [Известные проблемы реализации](#известные-проблемы-реализации)
 - [Политики безопасности](#политики-безопасности)
 - [Запуск приложения и тестов](#запуск-приложения-и-тестов)
    - [Запуск приложения](#запуск-приложения)
    - [Запуск тестов](#запуск-тестов)

## Постановка задачи
Необходимо создать программное обеспечение (далее – ПО) для робота-доставщика (далее – робот), с помощью которого можно обеспечить безопасную доставку и выдачу заказа (верифицированному) клиенту только в указанной точке, возвращение на базу и завершение работы.

## Известные ограничения, примечания и вводные данные:
**По условию:**
1. По условиям организаторов должна использоваться микросервисная архитектура и шина обмена сообщениями для реализации асинхронной работы сервисов.
2. Между собой сервисы общаются через шину сообщений (message bus), а всё снаружи принимают в виде REST запросов.
3. Физическая надёжность аппаратуры не учитывается.
4. Заказ не имеет массы и объёма.
5. Графический интерфейс для взаимодействия с пользователем не требуется, достаточно примеров REST запросов.
6. Приборная точность позиционирования достаточна для выполнения задания доставки.
7. Механизм безопасной передачи пароля клиенту не требуется реализовывать в рамках работы -> клиент **знает** правильный пароль от заказа.
8. Задача считается завершенной только по прибытии обратно на базу.

**Добавленные в ходе анализа:**

8. Движение осуществляется итерационно по прямой.
9. База имеет фиксированные координаты (x0 = 0, y0 = 0).
10. Геолокация: позиционирование на местности по двум системам - GPS (спутниковая навигационная система) и ИНС (инерциальная навигационная система).
11. Автономность: робот должен корректно продолжать работу в т.ч. при потере связи с сервером или GPS вплоть до накопления некоторой критической ошибки ИНС (для упрощения был взят отрезок в половину расстояния до следующей запланированной точки движения), а иначе попытка возвращения на базу.
12. Х1 и Y1 - адрес доставки заказа.
13. По умолчанию батареи робота хватает на доставку в квадрате с противолежащими вершинами (-100;-100) и (100;100) (т.е. заказы с координатами выходящими за рамки этого квадрата должны отсекаться системой безопасности робота).  
14. Контроль: уровень заряда, распознавание препятствий, поломка. В случае критических проблем дрон должен вернуться на базу.


### Цели и Предположения Безопасности (ЦПБ)
**Бизнес-цель:**
  - Доставка и выдача верифицированному клиенту заказа в заданной точке.

**Цели безопасности:**
1. Обеспечение сохранности груза до момента передачи авторизованному клиенту.
2. Получение задания только от корпоративного сервера.
3. В случае многократных попыток неавторизованного доступа заблокировать груз и вернуться на склад.
**Добавленные:**
4. Осуществлять проверку пинкода только по достижению указанной в заказе точки.
5. В случае потери связи с GPS продолжать движение по ИНС, если сигнал не вернется - возвращаться на базу.
6. Базовая защита REST-коммуникаций.
7. Принимать только валидные заказы.
8. Сохранение "чувствительной" информации.

**Предположения безопасности:**

Целями безопасности дрона не являются:

1. Защита от атак с использованием физического доступа.
2. Защита от намеренного искажения GPS координат.

В силу невозможности своевременной реализации предполагаем также:

3. Компонент communication и gps обращается только к доверенному списку адресов.
4. Между компонентами fleet и communication (в идеале сразу center) реализовано e2e шифрование сообщений.

## Архитектура работы системы
![DFD](./pics/dfd.png?raw=true "Архитектура")

### Компоненты

| Название | Назначение | Комментарий |
|----|----|----|
|*Central Control Unit (central)* | Принимает в работу заказ, сохраняет требуемую точку доставки и пинкод, запускает расчет и старт движения. При получении сообщения о достижении точки назначения проверяет по координатам соответствие, разрешает считывать пинкод. Проверяет пинкод ограниченное количество раз, по закрытии или при ошибке пароля более 3 раз запускает расчет и движение обратно. По достижении пункта назначения инициирует отправку сообщения со статусом заказа через Communication на Fleet. Отслеживает прерывание сигнала gps. Отслеживает ошибки позиционирования, верит ИНС. |  |
|*Motion control (motion)* | Осуществляет движение по полученным направлению и скорости в течении заданного расстояния с учетом аппаратных ограничений. | |
|*Client (client)* | Взаимодействует с роботом через API. Использует для авторизации уже известный ему уникальный PIN код. | |
|*Fleet management service (fleet)*  | Абстрактный сотрудник выдает заказы роботу при помощи файла request.rest, получая на REST интерфейс уведомления о принятии заказа к выполнению и о результате доставки (т.е. в т.ч. и о неудачном возвращении робота на базу). | |
|*Позиционирование (position)* | Осуществляет функции расчета параметров движения. Строит аварийный маршрут возвращения на базу. Выдаёт текущие координаты (x, y).  | ИНС осталась в составе position, а gps вынесена в отдельную сущность в целях декомпозиции. |
|*GPS (gps)* | Осуществляет связь со спутником, выдает текущие координаты робота. Иногда отваливается - потеря сигнала происходит :) | |
|*Communication block (communication)* | Разворачивает REST API для приема заказа, передачи его далее по шине, а также для передачи сообщений подтверждения и результата доставки. | |
|*HMI (hmi)* | Разворачивает REST API для приема заказа и передачи его далее по шине. Поскольку подразумевается автономное функционирование робота, то данный элемент считаем аппаратной составляющей со всеми вытекающими последствиями для безопасности.  | |
|*Sensors (sensors)* | Открывают замки при команде от монитора безопасности, через 5 секунд закрывает, отправляя об этом сообщение. | Camera - вынесена отдельно в целях декомпозиции |
|*Camera (camera)* | При вводе пинкода должна осуществлять съемку человека, что он забрал заказ. | |
|*Security monitor*<br>(монитор безопасности) | Авторизует операцию, если она удовлетворяет заданным правилам или блокирует её в противном случае | |
|*Message bus* | Шина сообщений и брокер - сервис передачи сообщений от источника получателям | kafka+zookeeper | |


### Алгоритм работы решения

![Sequence diagram](./pics/sd.png?raw=true "Диаграмма вызовов")

---
Message bus и Security Monitor на диаграммах опущены для лучшей читаемости и уменьшения размера картинки. КАЖДОЕ сообщение внутри системы проходит через monitor, который, исходя из политик, принимает решение пропустить его или нет.
---

### Описание Сценариев (последовательности выполнения операций), при которых ЦБ нарушаются

Для начала произведем анализ системы.
По условию задания, компоненты **Message Bus** и **Security Monitor** доверенные, что вполне логично - они являются основополагающими элементами взаимодействия системы.
Рассмотрим теперь **Central Control Unit** - он является главным логическим узлом всей системы, следовательно также будет являться доверенным. Остается вопрос - можно ли вынести из него некоторый функционал, чтобы уменьшить количество кода, требующего проверки. Представляется, что на данный момент такого функционала нет.

Сугубо теоретически, возможно представить вынос основных функций **central** в **monitor**, однако это фактически все равно не приводит к уменьшению проверяемой кодовой базы в два раза, а кроме того нарушается логика разделения компонентов. Кроме того, укрупнение компонентов так же видится негативной практикой.

В результате авторской оценки, блок **position** был усложнен до более реальной схемы с двумя независимыми блоками исчисления координат - **GPS** (вынесен отдельно) и **ИНС (Microelectromechanical systems (mems))** (остался в составе **position**), что позволяет закрыть вопрос с однозначной оценкой точного местоположения и таким образом закрывает требование ЦБ о выдаче заказа только в заданной точке.

Т.к. реальное движение подразумевает итерационность, то единый акт движения по прямой, предусмотренный изначальным ТЗ, также был усложнен и разбит на некоторое случайное число отрезков. 
В результате, во-первых, конечную точку маршрута знает только **center**, ну и **communication**, т.к. он промежуточный (есть нюансы - смотри рассуждения о шифровании в соответсвующем модуле), а во-вторых, в рамках каждого короткого отрезка становится возможно отслеживать координаты одновременно по данным ИНС (**position**) и GPS. 
Поскольку резервное возвращение осуществляется блоком ИНС, а наши координаты важны для ЦБ, то ИНС будет включаться в состав **position** и будет доверенным.
Тогда если результаты работы gps и ИНС не совпадут, то можно будет доверять ИНС. 
Отсюда следует, что при отказе gps, можно еще некоторое время двигаться вперед по ИНС, а если сигнал не вернется, то вернуться на базу. В целях упрощения данного механизма, было принято решение, что робот сможет доехать лишь до середины следующей запланированной итерации при отказе gps, а если там сигнал не вернется, то вернуться на базу.
Отказ gps осуществляется случайным вызовом соответствующей функции, следовательно в работе может произойти в любой момент.

---
Внимание! Добавление новых (не указанных в изначальном ТЗ) аппаратных компонентов (в данном случае введение сущностей gps/mems) со своей спецификой является нерекомендуемым направлением авторского (экспертного) анализа и не оптимальным способом решения найденной проблемы. Вероятно, это приведет к значительному увеличению требуемого на реализацию времени, хотя и концептуально не противоречит истине. Таким образом, более эффективным представляется поиск программного способа решения задачи.
---

Идем дальше. Если будет взломан компонент **motion**, то это приведет к нарушению бизнес-функции робота, но заявленные ЦБ будут выполняться.

Поскольку автор исходит из того, что **HMI** - интерфейс на роботе, недоступный извне через REST (т.е. не так, как это реализовано сейчас для удобства), то взлом **HMI** приведет максимум к нарушению бизнес-функции робота, но ЦБ будут соблюдаться. Возможно, что злоумышленник постфактум сможет узнать пароль, введенный клиентом (в комбинации с другими взломами), но т.к. **HMI** активируется только при достижении заявленной точки, то это не является проблемой. Впрочем, могут быть вопросы к реверсу генератора случайных паролей на сервере при большой выборке данных, но это уже выходит за рамки работы.

Самой серьезной проблемой представляется взлом замков **Sensors**, что позволит злоумышленнику просто их открыть. Таким образом, компонент следует добавить в доверенные компоненты. По этой причине, блок **Camera** был вынесен отдельно - чтобы не проверять его, поскольку он не оказывает влияние на ЦБ и на основную функцию.

Проблема могла бы быть, если взломан **Communication** – поскольку в реализации заказ один, то получение нового заказа при выполнении старого перезаписало бы требуемый пинкод и адрес, и позволило бы злоумышленнику получать чужой заказ. Для противодействия этого была реализована блокировка приема новых сообщений через политики безопасности до возвращения робота на базу.
Кроме того, у робота фактически есть две внешние точки доступа – через **GPS** и **Communication**, который, к тому же использует Flask. Следовательно – оба этих компонента следует тщательно досматривать – на политики проверки сообщений от них навесить жесткие ограничения по валидации содержимого: длина, значения, отрубать их при возможности, а также уделить особое внимание настройке сетевых параметров так, чтобы связаться с ними можно было только от заранее указанного сервера с авторизацией и т.д. 
Кроме того, в случае **Communication** имеется смысл, например, в реализации алгоритма Диффи-Хеллмана, т.е. обмена открытым-закрытым ключем для дешифровки сообщения. Возможно даже между fleet и center, а не communication. Впрочем, это выходит за рамки возможностей автора в установленные сроки, поэтому этот пункт вынесен в предположения безопасности.

Может ли комбинация взломов компонентов нарушить ЦБ? Понятно, что в случае доверенных компонент - да. Если же говорить о недоверенных, т.е. gps, hmi, motion, communication, camera - ни один из них не связан напрямую с другим, а следовательно их некорректное взаимодействие практически невозможно координировать между собой. Автор считает, что наиболее вероятная среди всех комбинаций - передача "лишней информации" с телом корректного ответа компонента и дальнейшая его передача через communication, которая где-то по пути перехватывается злоумышленником. Это частично решено путем проверки передаваемой "наружу" информации в monitor - т.е. при помощи политик.

Таким образом, становится возможным сформулировать список доверенных компонентов (см. соответствующий раздел) и рассмотреть возможные сценарии нарушения ЦБ.

Автором были определены 13 наиболее вероятных сценариев атаки на систему:
1. DDOS атака на Communication;
2. Заказ прислан злоумышленником, а не сервером, сюда же MITM;
3. Взлом сервера и выдача им некорректного заказа - например, который находится слишком далеко.
4. Атака через Third-party software (например, Flask в communication);
5. Взлом Communication как открытой точки доступа в сеть;
6. Перезапись "чувствительных" данных при повторном заказе;
7. Бездействие какого-либо компонента;
8. Скрытые поля и их использование для code injections (на любой входной точке в систему, т.к. для надежности посчитаем, что любая внешняя защита может быть скомпрометированной);
9. Отказ модуля **gps** (и физический (потеря сигнала) и ложь в координатах (была приравнена в коде к отказу))
10. Ввод паролей не в пункте назначения;
11. Перебор паролей;
12. Получение неверных данных (например, координат) от компонента;
13. Вынос "чувствительной" информации (например, фото клиента) из системы при помощи комбинации взломанных компонентов;

Здесь необходимо сделать ремарку, что концепция сохранения локальных копий используемых библиотек и проверки только поступающих обновлений подразумевает идею о том, что в условиях разработанной архитектуры простая эксплуатация уже существующей уязвимости в компоненте не позволит выйти за его пределы, т.к. если это и возможно, то потребуется доступ на уровне RCE, т.е. злоумышленнику все равно придется как-то доставлять код во взломанный компонент, поэтому сделан специальный **communication** в качестве буфера перед системой и **monitor**, который позволяет осуществлять валидацию.

В результате, в текущей реализации системы наиболее вероятным представляется невыполнение бизнес-функции в результате атаки на робота при соблюдении всех заявленных ЦБ.

![Негативные сценарии](./pics/sd_risks.png?raw=true "Негативные сценарии")

### Негативный сценарий 1. DDOS атака на Communication
![Негативные сценарии](./pics/sd_1.png?raw=true "")

Нарушается цель безопасности №6 и бизнес-функция.
Компенсируется отключением компонента Communication до необходимости отправить сообщение со статусом операции (опционально, при получении какого-то количества "неправильных" сообщений), связью только с абонентами из white-list и т.п.

### Негативный сценарий 2. Заказ прислан злоумышленником
![Негативные сценарии](./pics/sd_2.png?raw=true "")

Нарушается цель безопасности №1,2.
Компенсируется использованием аутентификацией сервера, например, реализацией алгоритма Диффи-Халлмана и связью только с доверенным списком адресов.

### Негативный сценарий 3. Некорректный заказ
![Негативные сценарии](./pics/sd_3.png?raw=true "")

Нарушается цель безопасности №7.
Компенсируется валидацией заказа - как далеко находится точка, хватит ли до нее заряда и т.д.

### Негативный сценарий 4. Атака на Third-party software
![Негативные сценарии](./pics/sd_4.png?raw=true "")

Нарушается цель безопасности (в теории) №1,2,4,5,6.
Компенсируется проверкой входящих в доверенные компоненты частей, использованием локальных и/или проверенных копий библиотек, проверкой обновлений.

### Негативный сценарий 5. Взлом Communication
![Негативные сценарии](./pics/sd_5.png?raw=true "")

Нарушается цель безопасности №2,6.
Компенсируется настройкой доступа только с доверенного списка адресов, с четким содержимым входящих сообщений и т.п. безопасностью.

### Негативный сценарий 6. Перезапись данных при повторном заказе
![Негативные сценарии](./pics/sd_6.png?raw=true "")

Нарушается цель безопасности №1,2.
Компенсируется блокировкой возможности повторного заказа.

### Негативный сценарий 7. Бездействие компонента
![Негативные сценарии](./pics/sd_7.png?raw=true "")

Нарушается бизнес-функция.
Компенсация представляется невозможной -> решения автором не придумано. Возможно некий компонент, который будет обнаруживать "падение" компонента и перезапускать его. В идеале, можно даже представить, что он будет брать на себя его роль. А ля, есть сохраненный код компонентов, при падении одного из них и невозможности перезапуска, данный компонент-двойник берет нужный исходник и загружается в работу.

### Негативный сценарий 8. Скрытые поля
![Негативные сценарии](./pics/sd_8.png?raw=true "")

В данном случае не имеет значения, откуда пришли скрытые поля, от fleet или от хакера, т.к. это рассматривается в других сценариях атаки. Здесь важен факт попадания "лишних данных" в систему. 
Нарушается цель безопасности №1,7.
Компенсируется валидацией входящих (и опционально исходящих) сообщений, экранированием полей.

### Негативный сценарий 9. Отказ модуля gps
![Негативные сценарии](./pics/sd_9.png?raw=true "")

Нарушается цель безопасности №5.
Компенсируется еще на уровне логики работы системы.

### Негативный сценарий 10. Ввод пароля не в пункте назначения
![Негативные сценарии](./pics/sd_10.png?raw=true "")

Нарушается цель безопасности №4.
Компенсируется активацией компонента доверенным компонентом при достижении точки, что зафиксировано другим доверенным компонентом.

### Негативный сценарий 11. Перебор паролей
![Негативные сценарии](./pics/sd_11.png?raw=true "")

Нарушается цель безопасности №3.
Компенсируется ограничением количества попыток.

### Негативный сценарий 12. Получение неверных данных от компонента
![Негативные сценарии](./pics/sd_12.png?raw=true "")

Нарушается цель безопасности №1,2,3,4.
Компенсируется на уровне архитектуры системы.

### Негативный сценарий 13. Потеря чувствительной информации
![Негативные сценарии](./pics/sd_13.png?raw=true "")

Здесь следует сделать ремарку, что взламывается необязательно central, смысл в том, что лишняя информация к сообщению может быть приложена еще на более ранних этапах каким-либо взломанным (или плохо придуманным изначально) компонентом и затем долгое время гулять по системе. Но отправляется в конечном итоге она все равно из cental в communication. Поэтому рисунок такой, какой он есть.
Нарушается цель безопасности №8.
Компенсируется валидацией исходящих сообщений.


#### Сводная таблица негативных сценариев*

|№  | Название | Скомпрометированная/Атакованная часть системы | Нарушенная цель безопасности |
|----|----|----|----|
|1 | DDOS атака на Communication | Communication | 6 |
|2 | Заказ прислан злоумышленником | Communication, Central | 1,2 |
|3 | Некорректный заказ | Central | 7 |
|4 | Атака на Third-party software | Any untrusted | 1,2,4,5,6 |
|5 | Взлом Communication | Communication | 2,6 |
|6 | Перезапись данных при повторном заказе | Communication, Central | 1,2 |
|7 | Бездействие компонента | Any untrusted | - |
|8 | Скрытые поля | Communication, Central | 1,7 |
|9 | Отказ модуля gps | Position, GPS | 5 |
|10 | Ввод пароля не в пункте назначения | HMI | 4 |
|11 | Перебор паролей | Central | 3 |
|12 | Получение неверных данных от компонента | Central | 1,2,3,4 |
|13 | Потеря чувствительной информации | Communication | 8 |

### Указание "доверенных компонент" на архитектурной диаграмме.

В предыдущем разделе были рассмотрены возможные сценарии нарушения ЦБ, по результатам чего были определены доверенные компоненты - **monitor**, **message bus**, **position**, **central** и **sensors**, по причине того, что шина обмена сообщений и монитор безопасности являются общесистемными, а также мы хотим доверять результатам работы блока управления роботом, его модулю позиционирования и замкам хранилища заказа.

![DFD-TCB](./pics/dfd_trusted.png?raw=true "Доверенные компоненты")

Теоретически, шину обмена сообщениями можно сделать недоверенным компонентом, но тогда необходимо будет реализовать механизм верификации сообщений. Например, можно использовать технологию типа blockchain.
Цена этого изменения - усложнение обмена сообщениями, дополнительные накладные расходы на верификацию, снижение производительности системы, возможно также возникновение нестабильности и различные ситуации гонок.

### Известные проблемы реализации
- Нет штрафных санкций на некорректные координаты от gps. Т.е. при отказе gps - робот возвращается на базу. А при неверных координатах - просто едет по ИНС без ограничения по количеству. Вероятно, будет исправлено приравниванием несовпадения координат к ошибке отказа gps.
- Не реализованы тесты для части негативных сценариев, см. таблицу в соответствующем разделе.
- Не реализована проверка, что будет, если один компонент будет эмулировать другой, присылать одновременно разные ответы и т.д. Впрочем, это отдельная тема работы.

### Политики безопасности
```python {lineNo:true}
ordering = False

def check_operation(id, details):
    global ordering
    authorized = False
    # print(f"[debug] checking policies for event {id}, details: {details}")
    print(f"[info] checking policies for event {id},"\
          f" {details['source']}->{details['deliver_to']}: {details['operation']}")
    src = details['source']
    dst = details['deliver_to']
    operation = details['operation']
    
    if  src == 'communication' and dst == 'central' and operation == 'ordering':
        if type(details['pincode']) == str \
                and type(details['x1']) == int and type(details['y1']) == int \
                and abs(details['x1']) <= 100 and abs(details['y1']) <= 100  and len(details) == 7 :
            if not ordering:
                authorized = True
                ordering = True
            else:
                details['source'] = 'monitor'
                details['operation'] = 'reordering'
                details['deliver_to'] = 'monitor'
                proceed_to_deliver(id, details)
        else:
            details['source'] = 'monitor'
            details['operation'] = 'invalid_order'
            details['deliver_to'] = 'monitor'
            proceed_to_deliver(id, details)

    if src == 'central' and dst == 'communication' \
        and operation == 'confirmation':
        authorized = True    
    if src == 'central' and dst == 'position' \
        and operation == 'count_direction':
        authorized = True    
    if src == 'position' and dst == 'central' \
        and operation == 'count_direction':
        authorized = True    
    if src == 'central' and dst == 'motion' \
        and operation == 'motion_start':
        authorized = True    
    if src == 'motion' and dst == 'position' \
        and operation == 'motion_start':
        #and details['verified'] is True:
        authorized = True    
    if src == 'motion' and dst == 'position' \
        and operation == 'stop':
        authorized = True    
    if src == 'position' and dst == 'central' \
        and operation == 'stop':
        authorized = True
    if src == 'hmi' and dst == 'central' \
        and operation == 'pincoding':
        authorized = True    
    if src == 'central' and dst == 'sensors' \
        and operation == 'lock_opening':
        authorized = True
    if  src == 'sensors' and dst == 'central'\
        and operation == 'lock_closing':
        authorized = True
    if  src == 'central' and dst == 'communication'\
        and operation == 'operation_status' and len(details) == 4:
        authorized = True
        ordering = False
    if  src == 'central' and dst == 'camera'\
        and operation == 'activate':
        authorized = True
    if  src == 'central' and dst == 'camera'\
        and operation == 'deactivate':
        authorized = True

    if  src == 'monitor' and dst == 'monitor':
        authorized = True
    if  src == 'central' and dst == 'monitor':
        authorized = True

    #are not in code yet
    if  src == 'central' and dst == 'gps'\
        and operation == 'where_am_i':
        authorized = True
    #simple checking length of messages
    if  src == 'gps' and dst == 'central'\
        and operation == 'gps' and len(details) == 5:
        authorized = True
    if  src == 'gps' and dst == 'central'\
        and operation == 'gps_error' and len(details) == 4:
        authorized = True

    return authorized

```

## Запуск приложения и тестов

### Запуск приложения

см. [инструкцию по запуску](../../README.md)

### Запуск тестов

_Предполагается, что в ходе подготовки рабочего места все системные пакеты были установлены._

Запуск примера: открыть окно терминала в Visual Studio code, в папке delivery-robot с исходным кодом выполнить команду:

**make run**
или **docker-compose up -d**

Примечание: контейнер broker имеет свойство падать при запуске, поэтому спустя секунд 15 после запуска команды **make run** имеет смысл проверить, находится ли он в состоянии UP и в случае чего повторно его запустить.

Примечание 2: сервисам требуется некоторое время для начала обработки входящих сообщений от kafka, поэтому перед переходом к тестам следует сделать паузу не менее минуты.

Запуск тестов:
**make test**
или **pytest**

Будут выполнены 7 тестов, 1 общий на корректность работы, 6 на безопасность, ожидаемое время выполнения зависит от входных (x,y) и в среднем составляет ~ 6-8 минут.

Ожидаемый результат выглядит следующим образом:

![test](./pics/test_result.png?raw=true "Тестирование")

Можно заметить, что первая серия тестов прошла успешно, а во второй тест функциональности провален. Это обусловлено тем, что gps в случайные моменты времени отказывается работать (как и было задумано изначально автором), а потому тесты, действительно, могут не проходить. В таком случае нужно запустить их еще раз. Т.к. отказы случайные, то поведение тестового сценария повторяться не должно.

Кроме того стоит обратить внимание на таблицу покрытия тестами сценариев атаки:

| Название | Статус | Комментарий |
|----|----|----|
|ddos_communication|готов|-|
|unauthorized_order|готов|-|
|incorrect_order|готов|-|
|third_party_attack|-|Не может быть реализовано в тесте?|
|communication_hacking|-|Не может быть реализовано в тесте?|
|repeating_order|готов|-|
|inaction|-|Не может быть реализовано в тесте?|
|hidden_fields|см. валидацию полей в политиках|Не может быть реализовано, кроме как вручную, т.к. частично покрывается еще в incorrect_order + подразумевается поставка команд скомпрометированному  компоненту |
|gps_broken|см. реализацию|Это возможно иногда наблюдать вживую, если смотреть лог работы программы, а также, есть возможность руками поменять в файле gps/consumer.py строку 27, увеличив вероятность возникновения ошибки и посмотреть на результат|
|password_not_in_destination_point|готов|-|
|bruteforce|готов|-|
|component_lie|см. реализацию|Возможно наблюдать, если руками поменять в файле gps/consumer.py строки 33 и 34, вставив туда заведомо неверные координаты|
|sensitive_output|см. валидацию полей в политиках|Возможно наблюдать, если зайти в central/consumer.py, найти блок отправки операции operation_status и добавить туда какое-нибудь свое поле - тогда при выполнении в логах monitor должно будет отобразиться сообщение о блокировке операции по причине несоответсвия полей.|

